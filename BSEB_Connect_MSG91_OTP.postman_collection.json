{
  "info": {
    "name": "BSEB Connect MSG91 OTP",
    "description": "MSG91 OTP Integration endpoints for BSEB Connect application",
    "_postman_id": "msg91-otp-2024",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "_exporter_id": "claude-code-2024"
  },
  "item": [
    {
      "name": "MSG91 OTP",
      "item": [
        {
          "name": "Send OTP (Mobile)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Test if request was successful",
                  "pm.test(\"Status code is 201 or 200\", function () {",
                  "    pm.expect(pm.response.code).to.be.oneOf([200, 201]);",
                  "});",
                  "",
                  "// Parse response",
                  "const response = pm.response.json();",
                  "",
                  "// Test response structure",
                  "pm.test(\"Response has success property\", function () {",
                  "    pm.expect(response).to.have.property('success');",
                  "    pm.expect(response.success).to.be.true;",
                  "});",
                  "",
                  "pm.test(\"Response has message\", function () {",
                  "    pm.expect(response).to.have.property('message');",
                  "});",
                  "",
                  "pm.test(\"Response has masked identifier\", function () {",
                  "    pm.expect(response).to.have.property('identifier');",
                  "    pm.expect(response.identifier).to.include('*');",
                  "});",
                  "",
                  "// Save test phone for later use",
                  "if (response.success) {",
                  "    pm.environment.set(\"test_phone\", pm.variables.get(\"test_phone\"));",
                  "    console.log(\"OTP sent successfully to: \" + response.identifier);",
                  "}"
                ],
                "type": "text/javascript"
              }
            },
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Generate random test phone number if not set",
                  "if (!pm.environment.get(\"test_phone\")) {",
                  "    const randomPhone = \"98765\" + Math.floor(10000 + Math.random() * 90000);",
                  "    pm.environment.set(\"test_phone\", randomPhone);",
                  "}",
                  "",
                  "console.log(\"Sending OTP to phone: \" + pm.environment.get(\"test_phone\"));"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"identifier\": \"{{test_phone}}\",\n  \"type\": \"login\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": {
              "raw": "{{base_url}}{{api_path}}/auth/send-otp",
              "host": [
                "{{base_url}}{{api_path}}"
              ],
              "path": [
                "auth",
                "send-otp"
              ]
            },
            "description": "Send OTP to mobile number via MSG91"
          },
          "response": [
            {
              "name": "Success Response",
              "originalRequest": {
                "method": "POST",
                "header": [],
                "body": {
                  "mode": "raw",
                  "raw": "{\n  \"identifier\": \"9876543210\",\n  \"type\": \"login\"\n}",
                  "options": {
                    "raw": {
                      "language": "json"
                    }
                  }
                },
                "url": {
                  "raw": "{{base_url}}{{api_path}}/auth/send-otp",
                  "host": [
                    "{{base_url}}{{api_path}}"
                  ],
                  "path": [
                    "auth",
                    "send-otp"
                  ]
                }
              },
              "status": "OK",
              "code": 200,
              "_postman_previewlanguage": "json",
              "header": [
                {
                  "key": "Content-Type",
                  "value": "application/json"
                }
              ],
              "cookie": [],
              "body": "{\n  \"success\": true,\n  \"message\": \"OTP sent to mobile number\",\n  \"identifier\": \"******3210\"\n}"
            }
          ]
        },
        {
          "name": "Verify OTP (Mobile)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Test if request was successful",
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "// Parse response",
                  "const response = pm.response.json();",
                  "",
                  "// Test response structure",
                  "pm.test(\"Response has success property\", function () {",
                  "    pm.expect(response).to.have.property('success');",
                  "    pm.expect(response.success).to.be.true;",
                  "});",
                  "",
                  "pm.test(\"Response has message\", function () {",
                  "    pm.expect(response).to.have.property('message');",
                  "});",
                  "",
                  "// Save tokens if provided",
                  "if (response.access_token) {",
                  "    pm.environment.set(\"access_token\", response.access_token);",
                  "    console.log(\"Access token saved\");",
                  "}",
                  "",
                  "if (response.refresh_token) {",
                  "    pm.environment.set(\"refresh_token\", response.refresh_token);",
                  "    console.log(\"Refresh token saved\");",
                  "}"
                ],
                "type": "text/javascript"
              }
            },
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Use test OTP in development mode",
                  "if (pm.environment.get(\"NODE_ENV\") === \"development\") {",
                  "    pm.environment.set(\"test_otp\", \"123456\");",
                  "} else if (!pm.environment.get(\"test_otp\")) {",
                  "    // Prompt for OTP in production",
                  "    console.log(\"Please set test_otp variable with the OTP received on phone\");",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"identifier\": \"{{test_phone}}\",\n  \"otp\": \"{{test_otp}}\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": {
              "raw": "{{base_url}}{{api_path}}/auth/verify-otp",
              "host": [
                "{{base_url}}{{api_path}}"
              ],
              "path": [
                "auth",
                "verify-otp"
              ]
            },
            "description": "Verify OTP sent to mobile number"
          },
          "response": [
            {
              "name": "Success Response",
              "originalRequest": {
                "method": "POST",
                "header": [],
                "body": {
                  "mode": "raw",
                  "raw": "{\n  \"identifier\": \"9876543210\",\n  \"otp\": \"123456\"\n}",
                  "options": {
                    "raw": {
                      "language": "json"
                    }
                  }
                },
                "url": {
                  "raw": "{{base_url}}{{api_path}}/auth/verify-otp",
                  "host": [
                    "{{base_url}}{{api_path}}"
                  ],
                  "path": [
                    "auth",
                    "verify-otp"
                  ]
                }
              },
              "status": "OK",
              "code": 200,
              "_postman_previewlanguage": "json",
              "header": [
                {
                  "key": "Content-Type",
                  "value": "application/json"
                }
              ],
              "cookie": [],
              "body": "{\n  \"success\": true,\n  \"message\": \"OTP verified successfully\",\n  \"access_token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\",\n  \"refresh_token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\"\n}"
            }
          ]
        },
        {
          "name": "Resend OTP",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Test if request was successful or rate limited",
                  "pm.test(\"Status code is 200 or 429\", function () {",
                  "    pm.expect(pm.response.code).to.be.oneOf([200, 429]);",
                  "});",
                  "",
                  "// Parse response",
                  "const response = pm.response.json();",
                  "",
                  "if (pm.response.code === 200) {",
                  "    pm.test(\"Response has success property\", function () {",
                  "        pm.expect(response).to.have.property('success');",
                  "        pm.expect(response.success).to.be.true;",
                  "    });",
                  "    ",
                  "    pm.test(\"Response has message\", function () {",
                  "        pm.expect(response).to.have.property('message');",
                  "        pm.expect(response.message).to.include('resent');",
                  "    });",
                  "    ",
                  "    console.log(\"OTP resent successfully\");",
                  "} else if (pm.response.code === 429) {",
                  "    pm.test(\"Rate limit message received\", function () {",
                  "        pm.expect(response).to.have.property('message');",
                  "        pm.expect(response.message).to.include('wait');",
                  "    });",
                  "    ",
                  "    console.log(\"Rate limited: \" + response.message);",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"identifier\": \"{{test_phone}}\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": {
              "raw": "{{base_url}}{{api_path}}/auth/resend-otp",
              "host": [
                "{{base_url}}{{api_path}}"
              ],
              "path": [
                "auth",
                "resend-otp"
              ]
            },
            "description": "Resend OTP to mobile number (rate limited)"
          },
          "response": [
            {
              "name": "Success Response",
              "originalRequest": {
                "method": "POST",
                "header": [],
                "body": {
                  "mode": "raw",
                  "raw": "{\n  \"identifier\": \"9876543210\"\n}",
                  "options": {
                    "raw": {
                      "language": "json"
                    }
                  }
                },
                "url": {
                  "raw": "{{base_url}}{{api_path}}/auth/resend-otp",
                  "host": [
                    "{{base_url}}{{api_path}}"
                  ],
                  "path": [
                    "auth",
                    "resend-otp"
                  ]
                }
              },
              "status": "OK",
              "code": 200,
              "_postman_previewlanguage": "json",
              "header": [
                {
                  "key": "Content-Type",
                  "value": "application/json"
                }
              ],
              "cookie": [],
              "body": "{\n  \"success\": true,\n  \"message\": \"OTP resent successfully\"\n}"
            },
            {
              "name": "Rate Limited Response",
              "originalRequest": {
                "method": "POST",
                "header": [],
                "body": {
                  "mode": "raw",
                  "raw": "{\n  \"identifier\": \"9876543210\"\n}",
                  "options": {
                    "raw": {
                      "language": "json"
                    }
                  }
                },
                "url": {
                  "raw": "{{base_url}}{{api_path}}/auth/resend-otp",
                  "host": [
                    "{{base_url}}{{api_path}}"
                  ],
                  "path": [
                    "auth",
                    "resend-otp"
                  ]
                }
              },
              "status": "Too Many Requests",
              "code": 429,
              "_postman_previewlanguage": "json",
              "header": [
                {
                  "key": "Content-Type",
                  "value": "application/json"
                }
              ],
              "cookie": [],
              "body": "{\n  \"statusCode\": 429,\n  \"message\": \"Please wait before requesting another OTP\"\n}"
            }
          ]
        },
        {
          "name": "Send OTP (Email)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Test if request was successful",
                  "pm.test(\"Status code is 201 or 200\", function () {",
                  "    pm.expect(pm.response.code).to.be.oneOf([200, 201]);",
                  "});",
                  "",
                  "// Parse response",
                  "const response = pm.response.json();",
                  "",
                  "// Test response structure",
                  "pm.test(\"Response indicates OTP sent\", function () {",
                  "    pm.expect(response).to.satisfy(function(res) {",
                  "        return res.success === true || res.message.includes('sent');",
                  "    });",
                  "});",
                  "",
                  "console.log(\"OTP sent to email: \" + pm.environment.get(\"test_email\"));"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json",
                "type": "text"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"identifier\": \"{{test_email}}\",\n  \"type\": \"login\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": {
              "raw": "{{base_url}}{{api_path}}/auth/send-otp",
              "host": [
                "{{base_url}}{{api_path}}"
              ],
              "path": [
                "auth",
                "send-otp"
              ]
            },
            "description": "Send OTP to email address (falls back to existing email OTP logic)"
          },
          "response": []
        }
      ],
      "description": "MSG91 OTP integration endpoints for mobile and email authentication"
    },
    {
      "name": "Development Testing",
      "item": [
        {
          "name": "Test OTP Flow (Development)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// This test runs the complete OTP flow in development mode",
                  "// It uses the test OTP code (123456) configured for development",
                  "",
                  "console.log(\"Running complete OTP flow test...\");",
                  "",
                  "// Test configuration",
                  "const testPhone = \"9876543210\";",
                  "const testOTP = \"123456\"; // Development mode OTP",
                  "",
                  "// Step 1: Send OTP",
                  "pm.sendRequest({",
                  "    url: pm.environment.get(\"base_url\") + pm.environment.get(\"api_path\") + \"/auth/send-otp\",",
                  "    method: \"POST\",",
                  "    header: {",
                  "        \"Content-Type\": \"application/json\"",
                  "    },",
                  "    body: {",
                  "        mode: \"raw\",",
                  "        raw: JSON.stringify({",
                  "            identifier: testPhone,",
                  "            type: \"login\"",
                  "        })",
                  "    }",
                  "}, function(err, res) {",
                  "    if (err) {",
                  "        console.error(\"Send OTP failed:\", err);",
                  "        pm.test(\"Send OTP should succeed\", function() {",
                  "            pm.expect.fail(\"Send OTP request failed\");",
                  "        });",
                  "        return;",
                  "    }",
                  "    ",
                  "    console.log(\"Send OTP response:\", res.json());",
                  "    ",
                  "    pm.test(\"Send OTP succeeds\", function() {",
                  "        pm.expect(res.code).to.be.oneOf([200, 201]);",
                  "    });",
                  "    ",
                  "    // Step 2: Wait a moment then verify OTP",
                  "    setTimeout(function() {",
                  "        pm.sendRequest({",
                  "            url: pm.environment.get(\"base_url\") + pm.environment.get(\"api_path\") + \"/auth/verify-otp\",",
                  "            method: \"POST\",",
                  "            header: {",
                  "                \"Content-Type\": \"application/json\"",
                  "            },",
                  "            body: {",
                  "                mode: \"raw\",",
                  "                raw: JSON.stringify({",
                  "                    identifier: testPhone,",
                  "                    otp: testOTP",
                  "                })",
                  "            }",
                  "        }, function(err, res) {",
                  "            if (err) {",
                  "                console.error(\"Verify OTP failed:\", err);",
                  "                pm.test(\"Verify OTP should succeed\", function() {",
                  "                    pm.expect.fail(\"Verify OTP request failed\");",
                  "                });",
                  "                return;",
                  "            }",
                  "            ",
                  "            console.log(\"Verify OTP response:\", res.json());",
                  "            ",
                  "            pm.test(\"Verify OTP succeeds\", function() {",
                  "                pm.expect(res.code).to.equal(200);",
                  "            });",
                  "            ",
                  "            const verifyResponse = res.json();",
                  "            if (verifyResponse.access_token) {",
                  "                pm.environment.set(\"access_token\", verifyResponse.access_token);",
                  "                pm.environment.set(\"refresh_token\", verifyResponse.refresh_token);",
                  "                console.log(\"✅ Complete OTP flow test passed! Tokens saved.\");",
                  "            } else {",
                  "                console.log(\"⚠️ OTP verified but no tokens received (might need user creation logic)\");",
                  "            }",
                  "        });",
                  "    }, 1000);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}{{api_path}}/health",
              "host": [
                "{{base_url}}{{api_path}}"
              ],
              "path": [
                "health"
              ]
            },
            "description": "Run complete OTP flow test in development mode"
          },
          "response": []
        }
      ],
      "description": "Development mode testing endpoints using test OTP (123456)"
    }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// Set default test values if not already set",
          "if (!pm.environment.get(\"test_phone\")) {",
          "    pm.environment.set(\"test_phone\", \"9876543210\");",
          "}",
          "",
          "if (!pm.environment.get(\"test_email\")) {",
          "    pm.environment.set(\"test_email\", \"test@example.com\");",
          "}",
          "",
          "if (!pm.environment.get(\"test_otp\")) {",
          "    pm.environment.set(\"test_otp\", \"123456\"); // Development mode OTP",
          "}",
          "",
          "// Log current environment",
          "console.log(\"Current environment:\", pm.environment.get(\"base_url\"));"
        ]
      }
    },
    {
      "listen": "test",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// Global tests for all requests",
          "pm.test(\"Response time is less than 2000ms\", function () {",
          "    pm.expect(pm.response.responseTime).to.be.below(2000);",
          "});",
          "",
          "pm.test(\"Response has valid JSON\", function () {",
          "    pm.response.to.be.json;",
          "});"
        ]
      }
    }
  ],
  "variable": [
    {
      "key": "collection_id",
      "value": "msg91-otp-2024"
    }
  ]
}