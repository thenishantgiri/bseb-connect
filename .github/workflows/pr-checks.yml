name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '18.x'
  FLUTTER_VERSION: '3.16.0'

jobs:
  # ============== Code Quality Checks ==============
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Check for secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
        continue-on-error: true

      - name: Run security audit - Backend
        working-directory: backend
        run: |
          npm install -g pnpm
          pnpm audit --audit-level=moderate || true

      - name: Flutter analyze
        run: |
          flutter pub get
          flutter analyze --no-fatal-infos --no-fatal-warnings

      - name: Check Flutter formatting
        run: dart format --set-exit-if-changed .

      - name: Backend ESLint
        working-directory: backend
        run: |
          pnpm install
          pnpm run lint || true

      - name: Check for large files
        run: |
          find . -type f -size +1M | grep -v -E "(node_modules|.git|build|dist)" | while read file; do
            echo "Warning: Large file detected: $file ($(du -h "$file" | cut -f1))"
          done

  # ============== Test Coverage ==============
  test-coverage:
    name: Test Coverage
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Backend test coverage
        working-directory: backend
        run: |
          npm install -g pnpm
          pnpm install
          cat > .env.test <<EOF
          NODE_ENV=test
          DATABASE_URL=postgresql://test_user:test_pass@localhost:5432/test_db?schema=public
          JWT_SECRET=test-secret
          EOF
          pnpm run test:cov || true

      - name: Flutter test coverage
        run: |
          flutter pub get
          flutter test --coverage || true

      - name: Upload backend coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./backend/coverage/lcov.info
          flags: backend
          name: backend-coverage
        continue-on-error: true

      - name: Upload Flutter coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: flutter
          name: flutter-coverage
        continue-on-error: true

      - name: Comment PR with coverage
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            let comment = '## ðŸ“Š Test Coverage Report\n\n';

            // Add backend coverage if exists
            if (fs.existsSync('backend/coverage/coverage-summary.json')) {
              const coverage = JSON.parse(fs.readFileSync('backend/coverage/coverage-summary.json', 'utf8'));
              const total = coverage.total;
              comment += '### Backend Coverage\n';
              comment += `- Lines: ${total.lines.pct}%\n`;
              comment += `- Statements: ${total.statements.pct}%\n`;
              comment += `- Functions: ${total.functions.pct}%\n`;
              comment += `- Branches: ${total.branches.pct}%\n\n`;
            }

            comment += '---\n';
            comment += `Commit: ${context.sha.substring(0, 7)}\n`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
        continue-on-error: true

  # ============== Build Validation ==============
  build-validation:
    name: Build Validation
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [backend, flutter-android, flutter-web]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        if: matrix.target == 'backend'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Flutter
        if: startsWith(matrix.target, 'flutter')
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Build Backend
        if: matrix.target == 'backend'
        working-directory: backend
        run: |
          npm install -g pnpm
          pnpm install
          pnpm run build

      - name: Build Flutter Android
        if: matrix.target == 'flutter-android'
        run: |
          flutter pub get
          flutter build apk --debug

      - name: Build Flutter Web
        if: matrix.target == 'flutter-web'
        run: |
          flutter pub get
          flutter build web

      - name: Check build size
        run: |
          echo "### Build Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ matrix.target }}" = "backend" ]; then
            size=$(du -sh backend/dist | cut -f1)
            echo "Backend build size: $size" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ matrix.target }}" = "flutter-android" ]; then
            size=$(du -sh build/app/outputs/flutter-apk/app-debug.apk | cut -f1)
            echo "Android APK size: $size" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ matrix.target }}" = "flutter-web" ]; then
            size=$(du -sh build/web | cut -f1)
            echo "Web build size: $size" >> $GITHUB_STEP_SUMMARY
          fi

  # ============== Dependency Review ==============
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v3
        with:
          fail-on-severity: moderate

  # ============== PR Labels ==============
  pr-labeler:
    name: Auto Label PR
    runs-on: ubuntu-latest

    steps:
      - uses: actions/labeler@v4
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Add size labels
        uses: actions/github-script@v6
        with:
          script: |
            const { data: pullRequest } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const labels = [];
            const changes = pullRequest.additions + pullRequest.deletions;

            if (changes < 10) labels.push('size/XS');
            else if (changes < 30) labels.push('size/S');
            else if (changes < 100) labels.push('size/M');
            else if (changes < 500) labels.push('size/L');
            else labels.push('size/XL');

            if (pullRequest.title.toLowerCase().includes('fix')) labels.push('bug');
            if (pullRequest.title.toLowerCase().includes('feat')) labels.push('enhancement');
            if (pullRequest.title.toLowerCase().includes('docs')) labels.push('documentation');

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels
              });
            }
        continue-on-error: true

  # ============== Status Check ==============
  pr-status:
    name: PR Status Check
    runs-on: ubuntu-latest
    needs: [code-quality, test-coverage, build-validation]
    if: always()

    steps:
      - name: Check PR Status
        run: |
          echo "### PR Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All checks completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Coverage | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Validation | âœ… |" >> $GITHUB_STEP_SUMMARY