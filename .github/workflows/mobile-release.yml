name: Mobile App Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
      release_notes:
        description: 'Release notes'
        required: true
      platform:
        description: 'Platform to release'
        required: true
        default: 'both'
        type: choice
        options:
          - android
          - ios
          - both

env:
  FLUTTER_VERSION: '3.16.0'

jobs:
  # ============== Android Release ==============
  android-release:
    name: Android Release
    runs-on: ubuntu-latest
    if: inputs.platform == 'android' || inputs.platform == 'both'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '11'

      - name: Decode Android keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks
          echo "storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >> android/key.properties
          echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=upload-keystore.jks" >> android/key.properties

      - name: Update version
        run: |
          # Update pubspec.yaml version
          sed -i "s/version: .*/version: ${{ inputs.version }}/" pubspec.yaml

          # Calculate build number from version
          BUILD_NUMBER=$(echo "${{ inputs.version }}" | awk -F. '{print $1*10000 + $2*100 + $3}')

          # Update build number in pubspec.yaml
          sed -i "s/version: ${{ inputs.version }}.*/version: ${{ inputs.version }}+${BUILD_NUMBER}/" pubspec.yaml

      - name: Install dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release

      - name: Build App Bundle
        run: flutter build appbundle --release

      - name: Upload to Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.bseb.connect
          releaseFiles: build/app/outputs/bundle/release/app-release.aab
          track: internal  # or production, beta, alpha
          releaseName: v${{ inputs.version }}
          releaseNotes: ${{ inputs.release_notes }}
          status: draft

      - name: Upload APK as artifact
        uses: actions/upload-artifact@v3
        with:
          name: android-release-apk
          path: build/app/outputs/flutter-apk/app-release.apk

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: android-v${{ inputs.version }}
          name: Android Release v${{ inputs.version }}
          body: |
            ## Android Release v${{ inputs.version }}

            ### Release Notes
            ${{ inputs.release_notes }}

            ### Downloads
            - [APK](https://github.com/${{ github.repository }}/releases/download/android-v${{ inputs.version }}/app-release.apk)
          files: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab
          draft: false
          prerelease: false

  # ============== iOS Release ==============
  ios-release:
    name: iOS Release
    runs-on: macos-latest
    if: inputs.platform == 'ios' || inputs.platform == 'both'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Install Apple certificates
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.IOS_BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
        run: |
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # Import certificate and provisioning profile
          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode --output $CERTIFICATE_PATH
          echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode --output $PP_PATH

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate to keychain
          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # Apply provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles

      - name: Update version
        run: |
          # Update pubspec.yaml version
          sed -i '' "s/version: .*/version: ${{ inputs.version }}/" pubspec.yaml

          # Calculate build number
          BUILD_NUMBER=$(echo "${{ inputs.version }}" | awk -F. '{print $1*10000 + $2*100 + $3}')

          # Update build number in pubspec.yaml
          sed -i '' "s/version: ${{ inputs.version }}.*/version: ${{ inputs.version }}+${BUILD_NUMBER}/" pubspec.yaml

      - name: Install dependencies
        run: |
          flutter pub get
          cd ios && pod install && cd ..

      - name: Build iOS app
        run: flutter build ipa --release --export-options-plist=ios/ExportOptions.plist

      - name: Upload to App Store Connect
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
        run: |
          echo "$APP_STORE_CONNECT_API_KEY_BASE64" | base64 --decode > AuthKey.p8

          xcrun altool --upload-app \
            --type ios \
            --file build/ios/ipa/*.ipa \
            --apiKey "$APP_STORE_CONNECT_API_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_ISSUER_ID"

      - name: Upload IPA as artifact
        uses: actions/upload-artifact@v3
        with:
          name: ios-release-ipa
          path: build/ios/ipa/*.ipa

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ios-v${{ inputs.version }}
          name: iOS Release v${{ inputs.version }}
          body: |
            ## iOS Release v${{ inputs.version }}

            ### Release Notes
            ${{ inputs.release_notes }}

            ### TestFlight
            The app has been uploaded to App Store Connect and will be available on TestFlight soon.
          files: build/ios/ipa/*.ipa
          draft: false
          prerelease: false

  # ============== Post-Release Actions ==============
  post-release:
    name: Post Release Actions
    runs-on: ubuntu-latest
    needs: [android-release, ios-release]
    if: always()

    steps:
      - uses: actions/checkout@v4

      - name: Update version in repository
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Update version in pubspec.yaml
          sed -i "s/version: .*/version: ${{ inputs.version }}/" pubspec.yaml

          git add pubspec.yaml
          git commit -m "chore: bump version to ${{ inputs.version }}"
          git push

      - name: Create release tag
        run: |
          git tag -a "v${{ inputs.version }}" -m "Release v${{ inputs.version }}"
          git push origin "v${{ inputs.version }}"

      - name: Send release notification
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              attachments: [{
                color: 'good',
                text: `ðŸš€ New Release: v${{ inputs.version }}\n\nPlatforms: ${{ inputs.platform }}\n\nRelease Notes:\n${{ inputs.release_notes }}\n\n<https://github.com/${{ github.repository }}/releases|View Releases>`
              }]
            }
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true